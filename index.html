<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coin Forecast</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: #e2e8f0;
            min-height: 100vh;
            padding-top: 70px;
        }

        /* Navigation Bar Styles */
        nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid #10b981;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            height: 60px;
        }

        .nav-brand {
            font-size: 1.5em;
            font-weight: bold;
            color: #10b981;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-menu {
            display: flex;
            gap: 5px;
            list-style: none;
        }

        .nav-item {
            position: relative;
        }

        .nav-link {
            display: block;
            padding: 10px 20px;
            color: #cbd5e1;
            text-decoration: none;
            border-radius: 6px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-link:hover {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .nav-link.active {
            background: #10b981;
            color: white;
        }

        .nav-toggle {
            display: none;
            flex-direction: column;
            gap: 4px;
            cursor: pointer;
            padding: 8px;
        }

        .nav-toggle span {
            display: block;
            width: 25px;
            height: 3px;
            background: #10b981;
            border-radius: 3px;
            transition: all 0.3s ease;
        }

        .nav-toggle.active span:nth-child(1) {
            transform: rotate(45deg) translate(6px, 6px);
        }

        .nav-toggle.active span:nth-child(2) {
            opacity: 0;
        }

        .nav-toggle.active span:nth-child(3) {
            transform: rotate(-45deg) translate(6px, -6px);
        }

        /* Mobile Navigation */
        @media (max-width: 768px) {
            .nav-toggle {
                display: flex;
            }

            .nav-menu {
                position: fixed;
                top: 60px;
                left: -100%;
                width: 100%;
                flex-direction: column;
                background: rgba(15, 23, 42, 0.98);
                backdrop-filter: blur(10px);
                padding: 20px;
                gap: 10px;
                transition: left 0.3s ease;
                border-bottom: 2px solid #10b981;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            }

            .nav-menu.active {
                left: 0;
            }

            .nav-link {
                padding: 15px 20px;
                text-align: center;
            }
        }

        /* Page Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Existing Styles */
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 12px;
            border: 2px solid #10b981;
        }

        .header h1 {
            color: #10b981;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #94a3b8;
            font-size: 1.1em;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 968px) {
            .dashboard {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .nav-brand {
                font-size: 1.2em;
            }
        }

        .panel {
            background: #1e293b;
            border-radius: 12px;
            padding: 25px;
            border: 1px solid #334155;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            overflow-x: auto;
        }

        @media (max-width: 768px) {
            .panel {
                padding: 15px;
            }
        }

        .panel h2 {
            color: #10b981;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #334155;
            padding-bottom: 10px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #cbd5e1;
            font-weight: 500;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 10px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 6px;
            color: #e2e8f0;
            font-size: 1em;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn-primary {
            background: #10b981;
            color: white;
        }

        .btn-primary:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
        }

        .btn-secondary {
            background: #475569;
            color: white;
        }

        .btn-secondary:hover {
            background: #334155;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-unsaved {
            background: #f59e0b !important;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            overflow-x: auto;
            display: block;
        }

        @media (max-width: 768px) {
            table {
                font-size: 0.9em;
            }
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #334155;
        }

        th {
            background: #0f172a;
            color: #10b981;
            font-weight: 600;
        }

        td input {
            width: 100%;
            padding: 6px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 4px;
            color: #e2e8f0;
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-wrapper input[type="checkbox"] {
            width: auto;
        }

        /* Stats Row */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #334155;
            text-align: center;
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            border-color: #10b981;
        }

        .stat-label {
            color: #94a3b8;
            font-size: 0.9em;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #10b981;
        }

        .forecast-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .week-card {
            background: #1e293b;
            border-radius: 8px;
            padding: 20px;
            border: 2px solid #334155;
            transition: transform 0.2s ease;
            min-height: 200px;
        }

        .week-card:hover {
            transform: translateY(-4px);
        }

        .week-card.surplus {
            border-color: #10b981;
            background: linear-gradient(135deg, #1e293b 0%, #064e3b 100%);
        }

        .week-card.deficit {
            border-color: #ef4444;
            background: linear-gradient(135deg, #1e293b 0%, #7f1d1d 100%);
        }

        .week-header {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #10b981;
        }

        .week-stat {
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
        }

        .week-stat-label {
            color: #94a3b8;
        }

        .week-stat-value {
            font-weight: 600;
        }

        .positive {
            color: #10b981;
        }

        .negative {
            color: #ef4444;
        }

        .action-item {
            background: rgba(16, 185, 129, 0.05);
            border-left: 4px solid #10b981;
            padding: 15px;
            margin: 15px 0;
            border-radius: 6px;
        }

        .warning-box {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid #ef4444;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .warning-box h3 {
            color: #ef4444;
            margin-bottom: 15px;
        }

        .success-box {
            background: rgba(16, 185, 129, 0.1);
            border: 2px solid #10b981;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .success-box h3 {
            color: #10b981;
            margin-bottom: 15px;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
            width: 100%;
        }

        @media (max-width: 768px) {
            .chart-container {
                height: 300px;
                margin: 10px 0;
            }
            
            .chart-container canvas {
                max-width: 100%;
                height: auto !important;
            }
        }

        @media (max-width: 480px) {
            .chart-container {
                height: 250px;
            }
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid #334155;
            border-top: 4px solid #10b981;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav>
        <div class="nav-container">
            <div class="nav-brand">
                üí∞ Coin Forecast
            </div>
            <div class="nav-toggle" id="navToggle">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <ul class="nav-menu" id="navMenu">
                <li class="nav-item">
                    <a href="#" class="nav-link active" data-page="dashboard">Dashboard</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="forecast">Forecast</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="config">Configuration</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="action">Action Plan</a>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <!-- Dashboard Page -->
        <div id="dashboard" class="page active">
            <div class="header">
                <h1>üí∞ Financial Dashboard</h1>
                <p>Your Financial Overview at a Glance</p>
            </div>

            <!-- Stats Row -->
            <div class="stats-row" id="statsRow"></div>

            <!-- Quick Summary Panel -->
            <div class="panel">
                <h2>üìä Financial Summary</h2>
                <div id="quickStats"></div>
            </div>

            <!-- Recent Activity -->
            <div class="panel" style="margin-top: 20px;">
                <h2>üìà Quick Actions</h2>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="navigateToPage('config')">‚öôÔ∏è Configure Income & Expenses</button>
                    <button class="btn btn-primary" onclick="navigateToPage('forecast')">üìä View Forecast</button>
                    <button class="btn btn-secondary" onclick="generateActionPlan(); navigateToPage('action')">üéØ Generate Action Plan</button>
                </div>
            </div>
        </div>

        <!-- Forecast Page -->
        <div id="forecast" class="page">
            <div class="header">
                <h1>üìä 6-Week Forecast</h1>
                <p>Projected Cash Flow Analysis</p>
            </div>

            <!-- Chart Panel -->
            <div class="panel">
                <h2>Cash Flow Projection</h2>
                <div class="chart-container">
                    <canvas id="forecastChart"></canvas>
                </div>
            </div>

            <!-- Forecast Grid -->
            <div class="panel" style="margin-top: 20px;">
                <h2>Weekly Breakdown</h2>
                <div class="forecast-grid" id="forecastGrid"></div>
            </div>
        </div>

        <!-- Configuration Page -->
        <div id="config" class="page">
            <div class="header">
                <h1>‚öôÔ∏è Configuration</h1>
                <p>Manage Your Income and Expenses</p>
            </div>

            <div class="dashboard">
                <!-- Current Balance Panel -->
                <div class="panel">
                    <h2>üíµ Current Balance</h2>
                    <div class="input-group">
                        <label for="currentBalance">Starting Balance ($)</label>
                        <input type="number" id="currentBalance" step="0.01" value="0">
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="panel">
                    <h2>üìä Quick Stats</h2>
                    <div id="quickStatsConfig"></div>
                </div>

                <!-- Income Configuration -->
                <div class="panel">
                    <h2>üí∞ Income Configuration</h2>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button class="btn btn-primary" onclick="addIncome()">+ Add Income Source</button>
                        <button class="btn btn-secondary" onclick="saveIncomeData()" id="saveIncomeBtn">üíæ Save Income</button>
                    </div>
                    <table id="incomeTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Amount ($)</th>
                                <th>Frequency</th>
                                <th>Next Date</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <!-- Expense Configuration -->
                <div class="panel">
                    <h2>üí∏ Expense Configuration</h2>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button class="btn btn-primary" onclick="addExpense()">+ Add Expense</button>
                        <button class="btn btn-secondary" onclick="saveExpenseData()" id="saveExpenseBtn">üíæ Save Expenses</button>
                    </div>
                    <table id="expenseTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Amount ($)</th>
                                <th>Frequency</th>
                                <th>Next Date</th>
                                <th>Essential</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" onclick="saveAllData()" id="saveAllBtn">üíæ Save All Changes</button>
                <button class="btn btn-secondary" onclick="exportData()">üì• Export Data</button>
                <button class="btn btn-secondary" onclick="importData()">üì§ Import Data</button>
                <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
            </div>
        </div>

        <!-- Action Plan Page -->
        <div id="action" class="page">
            <div class="header">
                <h1>üéØ Action Plan</h1>
                <p>Personalized Financial Recommendations</p>
            </div>

            <div class="panel">
                <button class="btn btn-primary" onclick="generateActionPlan()" style="margin-bottom: 20px;">
                    üîÑ Regenerate Action Plan
                </button>
                <div id="actionPlanContent">
                    <p style="color: #94a3b8; text-align: center; padding: 40px;">
                        Click "Generate Action Plan" to get personalized financial recommendations.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let incomes = [];
        let expenses = [];
        let currentBalance = 0;
        let forecastChart = null;
        let hasUnsavedIncomes = false;
        let hasUnsavedExpenses = false;

        // Navigation Logic
        const navToggle = document.getElementById('navToggle');
        const navMenu = document.getElementById('navMenu');
        const navLinks = document.querySelectorAll('.nav-link');

        navToggle.addEventListener('click', () => {
            navToggle.classList.toggle('active');
            navMenu.classList.toggle('active');
        });

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const pageName = link.getAttribute('data-page');
                navigateToPage(pageName);
                
                // Close mobile menu
                navToggle.classList.remove('active');
                navMenu.classList.remove('active');
            });
        });

        function navigateToPage(pageName) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });

            // Show selected page
            document.getElementById(pageName).classList.add('active');

            // Update nav links
            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('data-page') === pageName) {
                    link.classList.add('active');
                }
            });

            // Update specific page content
            if (pageName === 'forecast') {
                renderForecastPage();
            } else if (pageName === 'dashboard') {
                updateDashboard();
            } else if (pageName === 'config') {
                updateConfigPage();
            }

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Initialize
        function init() {
            loadData();
            updateAllViews();
        }

        function loadData() {
            const saved = localStorage.getItem('cashFlowData');
            if (saved) {
                const data = JSON.parse(saved);
                incomes = data.incomes || [];
                expenses = data.expenses || [];
                currentBalance = data.currentBalance || 0;
                
                document.getElementById('currentBalance').value = currentBalance;
            }
            renderIncomesTable();
            renderExpensesTable();
        }

        function saveData() {
            currentBalance = parseFloat(document.getElementById('currentBalance').value) || 0;
            
            const data = {
                incomes,
                expenses,
                currentBalance,
                lastSaved: new Date().toISOString()
            };
            
            localStorage.setItem('cashFlowData', JSON.stringify(data));
        }

        function saveAllData() {
            saveData();
            
            // Reset all unsaved flags
            hasUnsavedIncomes = false;
            hasUnsavedExpenses = false;
            
            // Update button states
            const incomeBtn = document.getElementById('saveIncomeBtn');
            if (incomeBtn) {
                incomeBtn.classList.remove('btn-unsaved');
                incomeBtn.textContent = 'üíæ Save Income';
            }
            
            const expenseBtn = document.getElementById('saveExpenseBtn');
            if (expenseBtn) {
                expenseBtn.classList.remove('btn-unsaved');
                expenseBtn.textContent = 'üíæ Save Expenses';
            }
            
            const allBtn = document.getElementById('saveAllBtn');
            if (allBtn) {
                allBtn.classList.remove('btn-unsaved');
                allBtn.textContent = 'üíæ Save All Changes';
            }
            
            updateAllViews();
            
            // Show brief confirmation
            if (allBtn) {
                const originalText = allBtn.textContent;
                allBtn.textContent = '‚úì All Saved!';
                setTimeout(() => {
                    allBtn.textContent = originalText;
                }, 1500);
            }
        }

        function addIncome() {
            incomes.push({
                id: Date.now(),
                name: '',
                amount: 0,
                frequency: 'monthly',
                nextDate: new Date().toISOString().split('T')[0]
            });
            renderIncomesTable();
        }

        function removeIncome(id) {
            if (confirm('Remove this income source?')) {
                incomes = incomes.filter(inc => inc.id !== id);
                renderIncomesTable();
                saveData();
                updateAllViews();
                
                // Clear unsaved flag since we just saved
                hasUnsavedIncomes = false;
                const btn = document.getElementById('saveIncomeBtn');
                if (btn) {
                    btn.classList.remove('btn-unsaved');
                    btn.textContent = 'üíæ Save Income';
                }
            }
        }

        function addExpense() {
            expenses.push({
                id: Date.now(),
                name: '',
                amount: 0,
                frequency: 'monthly',
                nextDate: new Date().toISOString().split('T')[0],
                isEssential: false
            });
            renderExpensesTable();
        }

        function removeExpense(id) {
            if (confirm('Remove this expense?')) {
                expenses = expenses.filter(exp => exp.id !== id);
                renderExpensesTable();
                saveData();
                updateAllViews();
                
                // Clear unsaved flag since we just saved
                hasUnsavedExpenses = false;
                const btn = document.getElementById('saveExpenseBtn');
                if (btn) {
                    btn.classList.remove('btn-unsaved');
                    btn.textContent = 'üíæ Save Expenses';
                }
            }
        }

        function renderIncomesTable() {
            const tbody = document.querySelector('#incomeTable tbody');
            tbody.innerHTML = incomes.map(inc => `
                <tr>
                    <td><input type="text" value="${inc.name || ''}" onchange="updateIncome(${inc.id}, 'name', this.value)"></td>
                    <td><input type="number" step="0.01" value="${inc.amount || 0}" onchange="updateIncome(${inc.id}, 'amount', parseFloat(this.value))"></td>
                    <td>
                        <select onchange="updateIncome(${inc.id}, 'frequency', this.value)">
                            <option value="weekly" ${inc.frequency === 'weekly' ? 'selected' : ''}>Weekly</option>
                            <option value="biweekly" ${inc.frequency === 'biweekly' ? 'selected' : ''}>Bi-weekly</option>
                            <option value="monthly" ${inc.frequency === 'monthly' ? 'selected' : ''}>Monthly</option>
                        </select>
                    </td>
                    <td><input type="date" value="${inc.nextDate || ''}" onchange="updateIncome(${inc.id}, 'nextDate', this.value)"></td>
                    <td><button class="btn btn-danger" onclick="removeIncome(${inc.id})">Remove</button></td>
                </tr>
            `).join('');
        }

        function renderExpensesTable() {
            const tbody = document.querySelector('#expenseTable tbody');
            tbody.innerHTML = expenses.map(exp => `
                <tr>
                    <td><input type="text" value="${exp.name || ''}" onchange="updateExpense(${exp.id}, 'name', this.value)"></td>
                    <td><input type="number" step="0.01" value="${exp.amount || 0}" onchange="updateExpense(${exp.id}, 'amount', parseFloat(this.value))"></td>
                    <td>
                        <select onchange="updateExpense(${exp.id}, 'frequency', this.value)">
                            <option value="weekly" ${exp.frequency === 'weekly' ? 'selected' : ''}>Weekly</option>
                            <option value="biweekly" ${exp.frequency === 'biweekly' ? 'selected' : ''}>Bi-weekly</option>
                            <option value="monthly" ${exp.frequency === 'monthly' ? 'selected' : ''}>Monthly</option>
                        </select>
                    </td>
                    <td><input type="date" value="${exp.nextDate || ''}" onchange="updateExpense(${exp.id}, 'nextDate', this.value)"></td>
                    <td>
                        <div class="checkbox-wrapper">
                            <input type="checkbox" ${exp.isEssential ? 'checked' : ''} onchange="updateExpense(${exp.id}, 'isEssential', this.checked)">
                        </div>
                    </td>
                    <td><button class="btn btn-danger" onclick="removeExpense(${exp.id})">Remove</button></td>
                </tr>
            `).join('');
        }

        function updateIncome(id, field, value) {
            const income = incomes.find(inc => inc.id === id);
            if (income) {
                income[field] = value;
                
                // Check if row is complete (has name, amount, and date)
                const isComplete = income.name && income.name.trim() !== '' && 
                                 income.amount > 0 && 
                                 income.nextDate && income.nextDate !== '';
                
                if (isComplete) {
                    // Auto-save complete rows
                    saveData();
                    updateAllViews();
                } else {
                    // Mark as unsaved for incomplete rows
                    markIncomesUnsaved();
                }
            }
        }

        function updateExpense(id, field, value) {
            const expense = expenses.find(exp => exp.id === id);
            if (expense) {
                expense[field] = value;
                
                // Check if row is complete (has name, amount, and date)
                const isComplete = expense.name && expense.name.trim() !== '' && 
                                 expense.amount > 0 && 
                                 expense.nextDate && expense.nextDate !== '';
                
                if (isComplete) {
                    // Auto-save complete rows
                    saveData();
                    updateAllViews();
                } else {
                    // Mark as unsaved for incomplete rows
                    markExpensesUnsaved();
                }
            }
        }

        function markIncomesUnsaved() {
            hasUnsavedIncomes = true;
            const btn = document.getElementById('saveIncomeBtn');
            if (btn) {
                btn.classList.add('btn-unsaved');
                btn.textContent = 'üíæ Save Income *';
            }
        }

        function markExpensesUnsaved() {
            hasUnsavedExpenses = true;
            const btn = document.getElementById('saveExpenseBtn');
            if (btn) {
                btn.classList.add('btn-unsaved');
                btn.textContent = 'üíæ Save Expenses *';
            }
        }

        function saveIncomeData() {
            saveData();
            hasUnsavedIncomes = false;
            const btn = document.getElementById('saveIncomeBtn');
            if (btn) {
                btn.classList.remove('btn-unsaved');
                btn.textContent = 'üíæ Save Income';
            }
            updateAllViews();
            
            // Show brief confirmation
            const originalText = btn.textContent;
            btn.textContent = '‚úì Saved!';
            setTimeout(() => {
                btn.textContent = originalText;
            }, 1500);
        }

        function saveExpenseData() {
            saveData();
            hasUnsavedExpenses = false;
            const btn = document.getElementById('saveExpenseBtn');
            if (btn) {
                btn.classList.remove('btn-unsaved');
                btn.textContent = 'üíæ Save Expenses';
            }
            updateAllViews();
            
            // Show brief confirmation
            const originalText = btn.textContent;
            btn.textContent = '‚úì Saved!';
            setTimeout(() => {
                btn.textContent = originalText;
            }, 1500);
        }

        function calculateForecast() {
            const forecast = [];
            let balance = currentBalance;
            const startDate = new Date();

            for (let week = 1; week <= 6; week++) {
                const weekStart = new Date(startDate);
                weekStart.setDate(startDate.getDate() + (week - 1) * 7);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);

                let weekInflow = 0;
                let weekOutflow = 0;
                const itemsDue = [];

                // Calculate income for this week
                incomes.forEach(inc => {
                    const nextDate = new Date(inc.nextDate);
                    let isDue = false;

                    // Check if this income is due during this week
                    if (inc.frequency === 'weekly') {
                        isDue = true; // Weekly income occurs every week
                    } else if (inc.frequency === 'biweekly') {
                        // Check if the nextDate falls within this week or every 2 weeks from nextDate
                        const daysDiff = Math.floor((weekStart - nextDate) / (1000 * 60 * 60 * 24));
                        isDue = daysDiff >= 0 && daysDiff % 14 < 7;
                    } else if (inc.frequency === 'monthly') {
                        // Check if nextDate falls within this week
                        isDue = nextDate >= weekStart && nextDate <= weekEnd;
                    }

                    if (isDue) {
                        weekInflow += (inc.amount || 0);
                        itemsDue.push({
                            name: inc.name || 'Unnamed Income',
                            amount: inc.amount || 0,
                            type: 'income',
                            date: nextDate
                        });
                    }
                });

                // Calculate expenses for this week
                expenses.forEach(exp => {
                    const nextDate = new Date(exp.nextDate);
                    let isDue = false;

                    // Check if this expense is due during this week
                    if (exp.frequency === 'weekly') {
                        isDue = true; // Weekly expense occurs every week
                    } else if (exp.frequency === 'biweekly') {
                        // Check if the nextDate falls within this week or every 2 weeks from nextDate
                        const daysDiff = Math.floor((weekStart - nextDate) / (1000 * 60 * 60 * 24));
                        isDue = daysDiff >= 0 && daysDiff % 14 < 7;
                    } else if (exp.frequency === 'monthly') {
                        // Check if nextDate falls within this week
                        isDue = nextDate >= weekStart && nextDate <= weekEnd;
                    }

                    if (isDue) {
                        weekOutflow += (exp.amount || 0);
                        itemsDue.push({
                            name: exp.name || 'Unnamed Expense',
                            amount: exp.amount || 0,
                            type: 'expense',
                            date: nextDate,
                            isEssential: exp.isEssential
                        });
                    }
                });

                const netChange = weekInflow - weekOutflow;
                balance += netChange;

                forecast.push({
                    weekNumber: week,
                    startDate: weekStart,
                    endDate: weekEnd,
                    inflow: weekInflow,
                    outflow: weekOutflow,
                    netChange: netChange,
                    endingBalance: balance,
                    itemsDue: itemsDue
                });
            }

            return forecast;
        }

        function renderForecastPage() {
            const forecast = calculateForecast();
            
            // Render chart
            renderForecastChart(forecast);
            
            // Render forecast grid
            const grid = document.getElementById('forecastGrid');
            grid.innerHTML = forecast.map(week => {
                const isDeficit = week.netChange < 0;
                const statusClass = isDeficit ? 'deficit' : 'surplus';
                
                // Sort items by date
                const sortedItems = week.itemsDue.sort((a, b) => a.date - b.date);
                
                // Format date range
                const dateRange = `${week.startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${week.endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
                
                // Create items due summary
                const itemsSummary = sortedItems.length > 0 ? `
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #334155;">
                        <div style="font-size: 0.9em; color: #94a3b8; margin-bottom: 8px; font-weight: 600;">Due This Week:</div>
                        ${sortedItems.map(item => {
                            const itemDate = item.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                            const itemClass = item.type === 'income' ? 'positive' : 'negative';
                            const itemIcon = item.type === 'income' ? 'üí∞' : 'üí∏';
                            const essentialBadge = item.type === 'expense' && item.isEssential ? '<span style="font-size: 0.75em; background: #ef4444; padding: 2px 6px; border-radius: 4px; margin-left: 4px;">Essential</span>' : '';
                            return `
                                <div style="font-size: 0.85em; margin: 6px 0; display: flex; justify-content: space-between; align-items: center;">
                                    <span style="color: #cbd5e1;">
                                        ${itemIcon} ${item.name}
                                        ${essentialBadge}
                                    </span>
                                    <span class="${itemClass}" style="font-weight: 600;">
                                        ${item.type === 'income' ? '+' : '-'}$${item.amount.toFixed(2)}
                                    </span>
                                </div>
                                <div style="font-size: 0.75em; color: #64748b; margin-left: 20px; margin-top: -4px;">${itemDate}</div>
                            `;
                        }).join('')}
                    </div>
                ` : '<div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #334155; font-size: 0.85em; color: #64748b; text-align: center;">No items due this week</div>';
                
                return `
                    <div class="week-card ${statusClass}">
                        <div class="week-header">Week ${week.weekNumber}</div>
                        <div style="font-size: 0.85em; color: #64748b; margin-bottom: 15px;">${dateRange}</div>
                        <div class="week-stat">
                            <span class="week-stat-label">Income:</span>
                            <span class="week-stat-value positive">$${week.inflow.toFixed(2)}</span>
                        </div>
                        <div class="week-stat">
                            <span class="week-stat-label">Expenses:</span>
                            <span class="week-stat-value negative">$${week.outflow.toFixed(2)}</span>
                        </div>
                        <div class="week-stat">
                            <span class="week-stat-label">Net Change:</span>
                            <span class="week-stat-value ${week.netChange >= 0 ? 'positive' : 'negative'}">
                                ${week.netChange >= 0 ? '+' : ''}$${week.netChange.toFixed(2)}
                            </span>
                        </div>
                        <div class="week-stat" style="border-top: 1px solid #334155; padding-top: 8px; margin-top: 8px;">
                            <span class="week-stat-label">Ending Balance:</span>
                            <span class="week-stat-value ${week.endingBalance >= 0 ? 'positive' : 'negative'}">
                                $${week.endingBalance.toFixed(2)}
                            </span>
                        </div>
                        ${itemsSummary}
                    </div>
                `;
            }).join('');
        }

        function renderForecastChart(forecast) {
            const ctx = document.getElementById('forecastChart');
            if (!ctx) return;
            
            const chartCtx = ctx.getContext('2d');
            
            if (forecastChart) {
                forecastChart.destroy();
            }
            
            const labels = forecast.map(week => `Week ${week.weekNumber}`);
            const balanceData = forecast.map(week => week.endingBalance);
            const inflowData = forecast.map(week => week.inflow);
            const outflowData = forecast.map(week => -week.outflow);
            
            // Responsive font sizes
            const isMobile = window.innerWidth < 768;
            const legendFontSize = isMobile ? 10 : 14;
            const titleFontSize = isMobile ? 14 : 18;
            const tickFontSize = isMobile ? 9 : 12;
            
            forecastChart = new Chart(chartCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Balance',
                            data: balanceData,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: isMobile ? 4 : 6,
                            pointHoverRadius: isMobile ? 6 : 8,
                            pointBackgroundColor: '#10b981',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2
                        },
                        {
                            label: 'Income',
                            data: inflowData,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.4,
                            pointRadius: isMobile ? 3 : 4,
                            pointHoverRadius: isMobile ? 5 : 6
                        },
                        {
                            label: 'Expenses',
                            data: outflowData,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.4,
                            pointRadius: isMobile ? 3 : 4,
                            pointHoverRadius: isMobile ? 5 : 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#e2e8f0',
                                font: {
                                    size: legendFontSize,
                                    weight: 'bold'
                                },
                                padding: isMobile ? 8 : 15,
                                usePointStyle: true,
                                boxWidth: isMobile ? 8 : 12,
                                boxHeight: isMobile ? 8 : 12
                            }
                        },
                        title: {
                            display: true,
                            text: '6-Week Cash Flow Projection',
                            color: '#10b981',
                            font: {
                                size: titleFontSize,
                                weight: 'bold'
                            },
                            padding: isMobile ? 10 : 20
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.95)',
                            titleColor: '#10b981',
                            bodyColor: '#e2e8f0',
                            borderColor: '#334155',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            titleFont: {
                                size: isMobile ? 11 : 13
                            },
                            bodyFont: {
                                size: isMobile ? 10 : 12
                            },
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += '$' + context.parsed.y.toFixed(2);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: '#334155',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#94a3b8',
                                font: {
                                    size: tickFontSize,
                                    weight: 'bold'
                                },
                                maxRotation: isMobile ? 45 : 0,
                                minRotation: isMobile ? 45 : 0
                            }
                        },
                        y: {
                            grid: {
                                color: '#334155',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#94a3b8',
                                font: {
                                    size: tickFontSize
                                },
                                callback: function(value) {
                                    return '$' + value.toFixed(0);
                                }
                            },
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        function updateDashboard() {
            updateStatsRow();
            updateQuickStats();
        }

        function updateConfigPage() {
            updateQuickStatsConfig();
        }

        function updateStatsRow() {
            const totalExpenses = expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
            const totalIncome = incomes.reduce((sum, inc) => sum + (inc.amount || 0), 0);
            const netMonthly = totalIncome - totalExpenses;

            const statsHTML = `
                <div class="stat-card">
                    <div class="stat-label">Current Balance</div>
                    <div class="stat-value ${currentBalance >= 0 ? 'positive' : 'negative'}">$${currentBalance.toFixed(0)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Income</div>
                    <div class="stat-value positive">$${totalIncome.toFixed(0)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Expenses</div>
                    <div class="stat-value negative">$${totalExpenses.toFixed(0)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Net Monthly</div>
                    <div class="stat-value ${netMonthly >= 0 ? 'positive' : 'negative'}">$${netMonthly.toFixed(0)}</div>
                </div>
            `;

            document.getElementById('statsRow').innerHTML = statsHTML;
        }

        function updateQuickStats() {
            const totalExpenses = expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
            const totalIncome = incomes.reduce((sum, inc) => sum + (inc.amount || 0), 0);
            const netMonthly = totalIncome - totalExpenses;

            const stats = `
                <div style="padding: 15px;">
                    <div class="week-stat">
                        <span class="week-stat-label">Current Balance:</span>
                        <span class="week-stat-value ${currentBalance >= 0 ? 'positive' : 'negative'}">$${currentBalance.toFixed(2)}</span>
                    </div>
                    <div class="week-stat">
                        <span class="week-stat-label">Total Income:</span>
                        <span class="week-stat-value positive">$${totalIncome.toFixed(2)}</span>
                    </div>
                    <div class="week-stat">
                        <span class="week-stat-label">Total Expenses:</span>
                        <span class="week-stat-value negative">$${totalExpenses.toFixed(2)}</span>
                    </div>
                    <div class="week-stat" style="border-top: 1px solid #334155; padding-top: 8px; margin-top: 8px;">
                        <span class="week-stat-label">Net Monthly:</span>
                        <span class="week-stat-value ${netMonthly >= 0 ? 'positive' : 'negative'}">$${netMonthly.toFixed(2)}</span>
                    </div>
                </div>
            `;

            document.getElementById('quickStats').innerHTML = stats;
        }

        function updateQuickStatsConfig() {
            const totalExpenses = expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
            const totalIncome = incomes.reduce((sum, inc) => sum + (inc.amount || 0), 0);
            const netMonthly = totalIncome - totalExpenses;

            const stats = `
                <div style="padding: 15px;">
                    <div class="week-stat">
                        <span class="week-stat-label">Current Balance:</span>
                        <span class="week-stat-value ${currentBalance >= 0 ? 'positive' : 'negative'}">$${currentBalance.toFixed(2)}</span>
                    </div>
                    <div class="week-stat">
                        <span class="week-stat-label">Total Income:</span>
                        <span class="week-stat-value positive">$${totalIncome.toFixed(2)}</span>
                    </div>
                    <div class="week-stat">
                        <span class="week-stat-label">Total Expenses:</span>
                        <span class="week-stat-value negative">$${totalExpenses.toFixed(2)}</span>
                    </div>
                    <div class="week-stat" style="border-top: 1px solid #334155; padding-top: 8px; margin-top: 8px;">
                        <span class="week-stat-label">Net Monthly:</span>
                        <span class="week-stat-value ${netMonthly >= 0 ? 'positive' : 'negative'}">$${netMonthly.toFixed(2)}</span>
                    </div>
                </div>
            `;

            const statsElement = document.getElementById('quickStatsConfig');
            if (statsElement) {
                statsElement.innerHTML = stats;
            }
        }

        function generateActionPlan() {
            const forecast = calculateForecast();
            const totalExpenses = expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
            const totalIncome = incomes.reduce((sum, inc) => sum + (inc.amount || 0), 0);
            const netMonthly = totalIncome - totalExpenses;
            
            const actionPlan = [];

            // Financial Health Status
            if (netMonthly >= 0 && currentBalance >= 0) {
                actionPlan.push(`
                    <div class="success-box">
                        <h3>‚úÖ Healthy Financial Position</h3>
                        <p>Your finances are in good shape! You have positive cash flow and a healthy balance.</p>
                        <ul style="margin-top: 10px; padding-left: 20px;">
                            <li>Consider building an emergency fund (3-6 months of expenses)</li>
                            <li>Look into investment opportunities</li>
                            <li>Review discretionary expenses for optimization</li>
                        </ul>
                    </div>
                `);
            } else if (netMonthly < 0) {
                actionPlan.push(`
                    <div class="warning-box">
                        <h3>‚ö†Ô∏è Negative Cash Flow Detected</h3>
                        <p>Your expenses exceed your income by $${Math.abs(netMonthly).toFixed(2)} per month.</p>
                        <ul style="margin-top: 10px; padding-left: 20px;">
                            <li>Identify and reduce non-essential expenses</li>
                            <li>Look for additional income opportunities</li>
                            <li>Prioritize essential expenses</li>
                        </ul>
                    </div>
                `);
            }

            // Deficit weeks warning
            const deficitWeeks = forecast.filter(w => w.endingBalance < 0);
            if (deficitWeeks.length > 0) {
                actionPlan.push(`
                    <div class="warning-box">
                        <h3>üö® Projected Deficit Weeks</h3>
                        <p>Your forecast shows ${deficitWeeks.length} week(s) with negative balance:</p>
                        <ul style="margin-top: 10px; padding-left: 20px;">
                            ${deficitWeeks.map(w => `<li>Week ${w.weekNumber}: $${w.endingBalance.toFixed(2)}</li>`).join('')}
                        </ul>
                    </div>
                `);
            }

            // Income breakdown
            actionPlan.push(`
                <div class="action-item">
                    <strong>üí∞ Income Breakdown:</strong>
                    ${incomes.length > 0 ? 
                        incomes.map(inc => `<div style="margin-top: 4px;">‚Ä¢ ${inc.name || 'Unnamed'}: $${(inc.amount || 0).toFixed(2)} (${inc.frequency})</div>`).join('') :
                        '<div style="margin-top: 4px;">No income sources configured</div>'
                    }
                </div>
            `);

            // Expense breakdown
            const essentialExpenses = expenses.filter(e => e.isEssential);
            const nonEssentialExpenses = expenses.filter(e => !e.isEssential);
            
            actionPlan.push(`
                <div class="action-item">
                    <strong>üí∏ Expense Breakdown:</strong>
                    ${expenses.length > 0 ? 
                        `<div style="margin-top: 10px;">
                            <strong>Essential Expenses:</strong>
                            ${essentialExpenses.length > 0 ? 
                                essentialExpenses.map(exp => `<div style="margin-top: 4px;">‚Ä¢ ${exp.name || 'Unnamed'}: $${(exp.amount || 0).toFixed(2)} (${exp.frequency})</div>`).join('') :
                                '<div style="margin-top: 4px;">None</div>'
                            }
                        </div>
                        <div style="margin-top: 10px;">
                            <strong>Non-Essential Expenses:</strong>
                            ${nonEssentialExpenses.length > 0 ? 
                                nonEssentialExpenses.map(exp => `<div style="margin-top: 4px;">‚Ä¢ ${exp.name || 'Unnamed'}: $${(exp.amount || 0).toFixed(2)} (${exp.frequency})</div>`).join('') :
                                '<div style="margin-top: 4px;">None</div>'
                            }
                        </div>` :
                        '<div style="margin-top: 4px;">No expenses configured</div>'
                    }
                </div>
            `);

            // Recommendations
            actionPlan.push(`
                <div class="action-item">
                    <strong>üí° Recommendations:</strong>
                    <div style="margin-top: 10px;">
                        ${netMonthly < 0 ? 
                            '<div>1. Focus on reducing non-essential expenses first</div>' : 
                            '<div>1. Continue maintaining positive cash flow</div>'
                        }
                        ${currentBalance < totalExpenses * 3 ? 
                            '<div>2. Build an emergency fund of 3-6 months expenses</div>' : 
                            '<div>2. Consider investment opportunities for surplus funds</div>'
                        }
                        <div>3. Review and adjust your budget monthly</div>
                        <div>4. Track actual spending vs. projected spending</div>
                    </div>
                </div>
            `);

            document.getElementById('actionPlanContent').innerHTML = actionPlan.join('');
        }

        function updateAllViews() {
            updateDashboard();
            updateConfigPage();
            // Don't automatically update forecast page to avoid unnecessary chart redraws
        }

        function exportData() {
            const data = {
                incomes,
                expenses,
                currentBalance,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `coinforecast-export-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json,.csv';
            
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = (event) => {
                    try {
                        const content = event.target.result;
                        
                        // Check if it's CSV or JSON
                        if (file.name.endsWith('.csv')) {
                            importCSV(content);
                        } else {
                            const data = JSON.parse(content);
                            
                            if (confirm('This will replace all current data. Continue?')) {
                                incomes = data.incomes || [];
                                expenses = data.expenses || [];
                                currentBalance = data.currentBalance || 0;
                                
                                // Reset unsaved flags
                                hasUnsavedIncomes = false;
                                hasUnsavedExpenses = false;
                                
                                saveData();
                                loadData();
                                updateAllViews();
                                
                                alert('Data imported successfully! ‚úì');
                            }
                        }
                    } catch (error) {
                        alert('Error importing data: ' + error.message);
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }

        function importCSV(csvContent) {
            const lines = csvContent.trim().split('\n');
            if (lines.length < 2) {
                alert('CSV file appears to be empty or invalid.');
                return;
            }

            // Parse header
            const headers = parseCSVLine(lines[0]);
            
            // Normalize headers (lowercase, trim)
            const normalizedHeaders = headers.map(h => h.toLowerCase().trim());
            
            // Detect column indices
            const columnMap = {
                name: findColumnIndex(normalizedHeaders, ['name', 'expense', 'description', 'item']),
                amount: findColumnIndex(normalizedHeaders, ['amount', 'cost', 'price', 'value']),
                date: findColumnIndex(normalizedHeaders, ['date', 'due date', 'due', 'next date', 'duedate']),
                frequency: findColumnIndex(normalizedHeaders, ['frequency', 'freq', 'recurring', 'period']),
                essential: findColumnIndex(normalizedHeaders, ['essential', 'necessary', 'required', 'priority']),
                type: findColumnIndex(normalizedHeaders, ['type', 'category'])
            };

            // Parse data rows
            const parsedData = [];
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length === 0 || values.every(v => !v.trim())) continue;

                const row = {
                    id: Date.now() + i,
                    name: columnMap.name !== -1 ? values[columnMap.name]?.trim() : '',
                    amount: columnMap.amount !== -1 ? parseAmount(values[columnMap.amount]) : 0,
                    frequency: columnMap.frequency !== -1 ? parseFrequency(values[columnMap.frequency]) : 'monthly',
                    nextDate: columnMap.date !== -1 ? parseDate(values[columnMap.date]) : new Date().toISOString().split('T')[0],
                    isEssential: columnMap.essential !== -1 ? parseBoolean(values[columnMap.essential]) : true
                };

                // Determine if it's income or expense based on type column or default to expense
                const typeValue = columnMap.type !== -1 ? values[columnMap.type]?.toLowerCase() : '';
                const isIncome = typeValue.includes('income') || typeValue.includes('revenue');
                
                parsedData.push({ ...row, isIncome });
            }

            // Ask user to specify type if no type column detected
            let userSpecifiedType = null;
            if (columnMap.type === -1) {
                const typeChoice = confirm(
                    `No "Type" column detected in CSV.\n\n` +
                    `Are these EXPENSES?\n\n` +
                    `‚Ä¢ Click OK for EXPENSES üí∏\n` +
                    `‚Ä¢ Click Cancel for INCOME üí∞`
                );
                userSpecifiedType = typeChoice ? 'expense' : 'income';
                
                // Override all items with user's choice
                parsedData.forEach(item => {
                    item.isIncome = userSpecifiedType === 'income';
                });
            }

            // Show preview and confirmation
            const incomeCount = parsedData.filter(d => d.isIncome).length;
            const expenseCount = parsedData.filter(d => !d.isIncome).length;
            
            const typeInfo = userSpecifiedType 
                ? `\n\nUser specified: ${userSpecifiedType === 'income' ? 'üí∞ Income' : 'üí∏ Expenses'}`
                : '';
            
            const message = `Found ${parsedData.length} items:\n` +
                `‚Ä¢ ${incomeCount} income sources\n` +
                `‚Ä¢ ${expenseCount} expenses\n\n` +
                `Columns detected:\n` +
                `‚Ä¢ Name: ${columnMap.name !== -1 ? '‚úì' : '‚úó'}\n` +
                `‚Ä¢ Amount: ${columnMap.amount !== -1 ? '‚úì' : '‚úó'}\n` +
                `‚Ä¢ Date: ${columnMap.date !== -1 ? '‚úì' : '‚úó'}\n` +
                `‚Ä¢ Frequency: ${columnMap.frequency !== -1 ? '‚úì' : '‚úó (defaulting to monthly)'}\n` +
                `‚Ä¢ Type: ${columnMap.type !== -1 ? '‚úì' : '‚úó (user specified)'}` +
                typeInfo +
                `\n\nReplace existing data or append to it?`;
            
            const shouldReplace = confirm(message + '\n\nOK = Replace   |   Cancel = Append');
            
            if (shouldReplace === null) return; // User cancelled entirely
            
            if (!shouldReplace) {
                // Append to existing data
                const newIncomes = parsedData.filter(d => d.isIncome).map(d => {
                    const { isIncome, ...rest } = d;
                    return rest;
                });
                const newExpenses = parsedData.filter(d => !d.isIncome).map(d => {
                    const { isIncome, ...rest } = d;
                    return rest;
                });
                
                incomes = [...incomes, ...newIncomes];
                expenses = [...expenses, ...newExpenses];
            } else {
                // Replace existing data
                incomes = parsedData.filter(d => d.isIncome).map(d => {
                    const { isIncome, ...rest } = d;
                    return rest;
                });
                expenses = parsedData.filter(d => !d.isIncome).map(d => {
                    const { isIncome, ...rest } = d;
                    return rest;
                });
            }
            
            // Reset unsaved flags
            hasUnsavedIncomes = false;
            hasUnsavedExpenses = false;
            
            saveData();
            loadData();
            updateAllViews();
            
            alert(`CSV imported successfully! ‚úì\nAdded ${incomeCount} income sources and ${expenseCount} expenses.`);
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            
            return result.map(val => val.replace(/^"|"$/g, '').trim());
        }

        function findColumnIndex(headers, possibleNames) {
            for (let name of possibleNames) {
                const index = headers.findIndex(h => h === name || h.includes(name));
                if (index !== -1) return index;
            }
            return -1;
        }

        function parseAmount(amountStr) {
            if (!amountStr) return 0;
            // Remove $, commas, and any other non-numeric characters except decimal point
            const cleaned = amountStr.replace(/[$,\s]/g, '');
            const amount = parseFloat(cleaned);
            return isNaN(amount) ? 0 : amount;
        }

        function parseDate(dateStr) {
            if (!dateStr) return new Date().toISOString().split('T')[0];
            
            const currentYear = new Date().getFullYear();
            
            // Try to parse various date formats
            // Format: "Jan 8", "January 8", "1/8", "01-08", etc.
            
            // Check if it's already in ISO format (YYYY-MM-DD)
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                return dateStr;
            }
            
            // Handle "Mon DD" or "Month DD" format (e.g., "Jan 8", "January 8")
            const monthDayMatch = dateStr.match(/^([A-Za-z]+)\s+(\d{1,2})$/);
            if (monthDayMatch) {
                const monthName = monthDayMatch[1];
                const day = parseInt(monthDayMatch[2]);
                
                const monthMap = {
                    'jan': 0, 'january': 0,
                    'feb': 1, 'february': 1,
                    'mar': 2, 'march': 2,
                    'apr': 3, 'april': 3,
                    'may': 4,
                    'jun': 5, 'june': 5,
                    'jul': 6, 'july': 6,
                    'aug': 7, 'august': 7,
                    'sep': 8, 'september': 8,
                    'oct': 9, 'october': 9,
                    'nov': 10, 'november': 10,
                    'dec': 11, 'december': 11
                };
                
                const month = monthMap[monthName.toLowerCase()];
                if (month !== undefined) {
                    const date = new Date(currentYear, month, day);
                    return date.toISOString().split('T')[0];
                }
            }
            
            // Try standard Date parsing as fallback
            const parsedDate = new Date(dateStr);
            if (!isNaN(parsedDate.getTime())) {
                return parsedDate.toISOString().split('T')[0];
            }
            
            // If all else fails, return today's date
            return new Date().toISOString().split('T')[0];
        }

        function parseFrequency(freqStr) {
            if (!freqStr) return 'monthly';
            
            const normalized = freqStr.toLowerCase().trim();
            
            if (normalized.includes('week') && !normalized.includes('bi')) return 'weekly';
            if (normalized.includes('biweek') || normalized.includes('bi-week') || normalized.includes('every 2 week')) return 'biweekly';
            if (normalized.includes('month')) return 'monthly';
            
            return 'monthly'; // Default
        }

        function parseBoolean(value) {
            if (!value) return false;
            
            const normalized = value.toString().toLowerCase().trim();
            return normalized === 'true' || normalized === 'yes' || normalized === '1' || normalized === 'y';
        }

        function clearAllData() {
            if (confirm('‚ö†Ô∏è This will delete ALL data. This cannot be undone. Continue?')) {
                if (confirm('Are you absolutely sure? This is your last chance!')) {
                    localStorage.removeItem('cashFlowData');
                    incomes = [];
                    expenses = [];
                    currentBalance = 0;
                    
                    // Reset unsaved flags
                    hasUnsavedIncomes = false;
                    hasUnsavedExpenses = false;
                    
                    document.getElementById('currentBalance').value = 0;
                    renderIncomesTable();
                    renderExpensesTable();
                    updateAllViews();
                    
                    alert('All data has been cleared.');
                }
            }
        }

        // Listen for current balance changes
        document.getElementById('currentBalance').addEventListener('change', function() {
            currentBalance = parseFloat(this.value) || 0;
            saveData();
            updateAllViews();
        });

        // Redraw chart on window resize for mobile responsiveness
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                // Check if we're on the forecast page
                const forecastPage = document.getElementById('forecast');
                if (forecastPage && forecastPage.classList.contains('active')) {
                    renderForecastPage();
                }
            }, 250);
        });

        // Initialize on page load
        window.addEventListener('load', init);
    </script>
</body>
</html>
